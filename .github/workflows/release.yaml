name: basebuild

on:
  pull_request:
  push:
    branches: [main]
    tags: [v*]

jobs:
  ci:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    env:
      flags: "--snapshot"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          # fall back to latest tag if present, otherwise 0.0.0-next
          VERSION="$(git describe --tags --abbrev=0 2>/dev/null || echo '0.0.0')-next"
          SHORT_SHA="$(git rev-parse --short HEAD)"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "build_time=${BUILD_TIME}" >> "$GITHUB_OUTPUT"

      - name: Set LDFLAGS env
        shell: bash
        run: |
          echo "LDFLAGS=-s -w -X github.com/pocketbase/pocketbase.Version=${{ steps.meta.outputs.version }} -X github.com/pocketbase/pocketbase.BuildCommit=${{ steps.meta.outputs.short_sha }} -X github.com/pocketbase/pocketbase.BuildTime=${{ steps.meta.outputs.build_time }}" >> "$GITHUB_ENV"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.17.0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '>=1.26.0'

      - name: Lint
        run: make lint

      - name: Check formatting
        run: |
          if [ -n "$(gofmt -d .)" ]; then
            echo "Code is not formatted. Run 'gofmt -w .' to fix."
            exit 1
          fi

      - name: Run tests
        run: go test -ldflags "${LDFLAGS}" ./...

      - name: Vet
        run: go vet ./...

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean ${{ env.flags }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute next version
        id: next_meta
        shell: bash
        run: |
          set -euo pipefail
          LATEST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || echo 'v0.0.0')"
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          echo "next_version=${NEXT_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag "v${{ steps.next_meta.outputs.next_version }}"
          git push origin "v${{ steps.next_meta.outputs.next_version }}"

  release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write # needed to push/move the lightweight "latest" tag
    env:
      flags: ""
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute version metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF#refs/tags/v}"
          SHORT_SHA="$(git rev-parse --short HEAD)"
          BUILD_TIME="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "build_time=${BUILD_TIME}" >> "$GITHUB_OUTPUT"

      - name: Set LDFLAGS env
        shell: bash
        run: |
          echo "LDFLAGS=-s -w -X github.com/pocketbase/pocketbase.Version=${{ steps.meta.outputs.version }} -X github.com/pocketbase/pocketbase.BuildCommit=${{ steps.meta.outputs.short_sha }} -X github.com/pocketbase/pocketbase.BuildTime=${{ steps.meta.outputs.build_time }}" >> "$GITHUB_ENV"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: v${{ steps.meta.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.meta.outputs.version, '-rc') || contains(steps.meta.outputs.version, '-beta') || contains(steps.meta.outputs.version, '-alpha') || contains(steps.meta.outputs.version, '-next') }}
          body: |
            Release ${{ steps.meta.outputs.version }}
            Commit ${{ steps.meta.outputs.short_sha }} built at ${{ steps.meta.outputs.build_time }}.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.17.0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '>=1.26.0'

      - name: Update latest tag
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          VERSION_TAG="${GITHUB_REF#refs/tags/}"
          echo "Moving 'latest' tag to ${VERSION_TAG}";
          # Delete remote latest if exists (ignore failure), then recreate & push
          git tag -f latest "$VERSION_TAG"
          git push origin :refs/tags/latest || true
          git push origin refs/tags/latest

      - name: Run tests
        run: go test -ldflags "${LDFLAGS}" ./...

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean ${{ env.flags }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
